---
title: Vignette for BayesMSN
author: "Carter Allen"
date: "5/12/2020"
output: pdf_document
vignette: >
  %\VignetteIndexEntry{Vignette for BayesMSN}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Installation

To install the `BayesMSN` package, use the code below. 

```{r, eval = FALSE}
devtools::install_github("carter-allen/BayesMSN")
```

# Overveiw

```{r}
library(BayesMSN)
```

# Example 1: Clustered, Skewed Repeated Measures without Missing Data

Included in the `BayesMSN` package is a simulated data set `example1_data`. This data set is meant to simulate longitudinal infant motor development scores as described in Allen et al. (2020). The infant motor development outcomes comprise $J = 4$ repeated measures recorded for $n = 1000$ infants. We also simulated one continuous time-invariant covariate that can be used to model the development scores, and a separate covariate that can be used in the clustering model. The `example1_data` object is a list of three matrices, `Y`, `X`, and `W`, which contain the repeated measures outcomes, regression covariates, and clustering covariates, respectively, as shown below. 

```{r}
str(example1_data)
```

The most basic model that can be fit with the `BayesMSN` package is a MSN mixture model where all repeated measure outcomes are non-missing, as is the case with `example1_data$Y`, which contains no missing values. To fit such a model, use the `fit_msn()` function as shown below. Note that the MCMC sampler runs at a rate of roughly 100 iterations per minute on most basic CPUs. 

```{r}
fit3 <- fit_msn(Y = example1_data$Y,
                X = example1_data$X,
                W = example1_data$W,
                K = 3,
                nsim = 100,
                burn = 0)
```

In the model `fit3` above, the number of clusters $K = 3$ was assumed to be known. However, in most applied settings the true value of $K$ is not known _a priori_. To choose the optimal value for $K$, we can use WAIC, a goodness of fit measure proposed by Watanabe (2010). The `BayesMSN` package includes a function `waic()`, which computes WAIC for models fit with `fit_msn()`, as demonstrated below. 

```{r}
fit3_waic <- waic(fit3)
fit3_waic
```

We can compare the value of WAIC for the three cluster model to those of models fit with other values of $K$, say $K = 2$ and $K = 4$, keeping in mind that the goal of modeling infant development data is to explain the the heterogeneity amoung development trajectories with a parsimonious set of development clusters. We note that mispecification of $K$ may lead to MCMC convergence issues. 

Once the optimal value for $K$ is chosen, we can inspect the posterior distributions of model parameters returned by the `fit_msn()` function. For full details on the parameters involved in the MSN mixture model see Allen et al. (2020). For cluster specific parameters such as $\mathbf{B}_k$ -- the matrix of MSN regression coefficients, a list of length $K$ is returned, where element $k$ of the list refers to the estimated parameters for cluster $k$. The `fit_msn()` function returns a total of `nsim - burn` posterior estimates of each parameter, as such, the matrices of posterior estimates `nsim - burn` rows, each corresponding to a draw from the posterior distribution of that parameter. For matrix parameters such as $\mathbf{B}_k$, each posterior sample is vectorized to be stored in the matrix of posterior samples returned by `fit_msn()`. 

To obtain posterior estimates of the regression parameters in `fit3`, we can utilize the `col_summarize()` function included in the `BayesMSN` package. This function accepts a numeric matrix as input and returns a posterior median and credible interval for each column of data in the matrix. A 95\% credible interval is used by default, though this can be controled by changing the `level` argument.

The posterior medians and 95\% credible intervals for the MSN regression coefficients for cluster 1 ($\beta_{111}, \beta_{112}, ..., \beta_{141}, \beta_{142}$) are computed below. 

```{r}
col_summarize(fit3$BETA[[1]])
```

Similarly, we can compute the posterior estimates of the parameters for the multinomial regression clustering model as follows. 

```{r}
col_summarize(fit3$DELTA)
```


# References

Allen, C., Neelon, B., Benjamin-Neelon, S.E. (2020). A Bayesian multivariate mixture model for skewed longitudinal data with intermittent missing observations: An application to infant motor development. 

Watanabe, S. (2010). Asymptotic equivalence of Bayes cross validation and widely applicable information criterion in singular learning theory. Journal of Machine Learning Research 11, 3571â€“3594.